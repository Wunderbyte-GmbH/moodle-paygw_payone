{"version":3,"sources":["../src/gateways_modal.js"],"names":["showModalWithPlaceholder","ModalFactory","Templates","render","body","create","modal","show","process","component","paymentArea","itemId","Promise","all","Repository","getConfigForJs","then","payunityConfig","purchaseid","loadSdk","environment","language","require","$","str","localStrings","get_strings","key","when","done","localizedEditStrings","type","types","CANCEL","title","buttons","cancel","root","getRoot","on","ModalEvents","location","href","rooturl","catch","form","document","createElement","resourcePath","url","setAttribute","classList","add","setBody","promise","window","addEventListener","resolve","base","sdkUrl","currentlyloaded","suspectedScript","querySelector","parentNode","removeChild","script","readyState","onreadystatechange","onload","optionscript","code","appendChild","createTextNode","head"],"mappings":"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","sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for PayUnity content in the gateways modal.\n *\n * @module     paygw_payunity/gateway_modal\n * @copyright  2022 Wunderbyte Gmbh <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Truncate from 'core/truncate';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_payunity/payunity_button_placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, payunityConfig]) => {\n        if (payunityConfig.purchaseid === null) {\n        return Promise.all([\n            modal, payunityConfig\n        ]\n        );\n        } else {\n        return Promise.all([\n            modal,\n            payunityConfig,\n            loadSdk(payunityConfig.purchaseid, payunityConfig.environment, payunityConfig.language),\n        ]);\n         }\n    })\n    .then(([modal, payunityConfig]) => {\n\n        if (payunityConfig.purchaseid === null) {\n\n            require(['jquery'], function($) {\n                require(['core/str'], function(str) {\n\n                    var strings = [\n                        {\n                            key: 'error',\n                            component: 'paygw_payunity'\n                        },\n                        {\n                            key: 'payment_error',\n                            component: 'paygw_payunity',\n                        },\n                        {\n                            key: 'proceed',\n                            component: 'paygw_payunity',\n                        }\n                    ];\n                    var localStrings = str.get_strings(strings);\n                    $.when(localStrings).done(function(localizedEditStrings) {\n                        ModalFactory.create({\n                            type: ModalFactory.types.CANCEL,\n                            title: localizedEditStrings[0],\n                            body: localizedEditStrings[1],\n                            buttons: {\n                                cancel: localizedEditStrings[2],\n                            },\n                        })\n                        .then(function(modal) {\n                            var root = modal.getRoot();\n                            // eslint-disable-next-line max-nested-callbacks\n                            root.on(ModalEvents.cancel, function() {\n                                location.href = payunityConfig.rooturl;\n                            });\n                            modal.show();\n                            return '';\n                        }).catch({\n                            // eslint-disable-next-line no-console\n                            // console.log(e);\n                        });\n                    });\n\n                    });\n            });\n        } else {\n       const form = document.createElement('form');\n       const resourcePath = `/v1/checkouts/${payunityConfig.purchaseid}/payment`;\n       const url = `${payunityConfig.rooturl}/payment/gateway/payunity/checkout.php?resourcepath=${resourcePath}&itemid=${itemId}&orderid=${payunityConfig.purchaseid}&component=${component}&paymentarea=${paymentArea}`;\n       form.setAttribute('action', url);\n       form.classList.add('paymentWidgets');\n       form.setAttribute('data-brands', \"EPS VISA MASTER\");\n       form.setAttribute('merchantTransactionId', \"test123\");\n        modal.setBody(form);\n        return '';\n        }\n        return '';\n    }).then(x => {\n        const promise = new Promise(resolve => {\n            window.addEventListener('onbeforeunload', (e) => {\n                promise.resolve();\n            });\n        });\n        return promise;\n    });\n};\n\n/**\n * Returns Form\n * @param {string} purchaseid Purchase Id\n * @param {string} environment Environment\n * @param {string} language Session language\n * @returns {Promise}\n */\nconst loadSdk = (purchaseid, environment, language) => {\n    let base = '';\n    if (environment === 'sandbox') {\n    base = 'https://eu-test.oppwa.com/';\n    } else {\n    base = 'https://eu-prod.oppwa.com/';\n    }\n    const sdkUrl = `${base}v1/paymentWidgets.js?checkoutId=${purchaseid}`;\n\n    // Check to see if this file has already been loaded. If so just go straight to the func.\n    if (loadSdk.currentlyloaded === sdkUrl) {\n        return Promise.resolve();\n    }\n\n    if (loadSdk.currentlyloaded) {\n        const suspectedScript = document.querySelector(`script[src=\"${loadSdk.currentlyloaded}\"]`);\n        if (suspectedScript) {\n            suspectedScript.parentNode.removeChild(suspectedScript);\n        }\n    }\n\n    const script = document.createElement('script');\n\n    return new Promise(resolve => {\n        if (script.readyState) {\n            script.onreadystatechange = function() {\n                if (this.readyState == 'complete' || this.readyState == 'loaded') {\n                    this.onreadystatechange = null;\n                    resolve();\n                }\n            };\n        } else {\n            script.onload = function() {\n                resolve();\n            };\n        }\n\n        script.setAttribute('src', sdkUrl);\n        const optionscript = document.createElement('script');\n        optionscript.type = 'text/javascript';\n        const lang = language;\n        const code = `var wpwlOptions = { locale: '${lang}'}`;\n        optionscript.appendChild(document.createTextNode(code));\n        document.head.appendChild(optionscript);\n        document.head.appendChild(script);\n        loadSdk.currentlyloaded = sdkUrl;\n    });\n};\n\n/**\n * Holds the full url\n *\n * @static\n * @type {string}\n */\n loadSdk.currentlyloaded = '';\n"],"file":"gateways_modal.min.js"}
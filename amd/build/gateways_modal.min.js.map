{"version":3,"sources":["../src/gateways_modal.js"],"names":["showModalWithPlaceholder","ModalFactory","Templates","render","body","create","modal","show","process","component","paymentArea","itemId","Promise","all","Repository","getConfigForJs","then","payunityConfig","loadSdk","purchaseid","environment","language","form","document","createElement","resourcePath","url","rooturl","setAttribute","classList","add","setBody","promise","window","addEventListener","resolve","base","sdkUrl","currentlyloaded","suspectedScript","querySelector","parentNode","removeChild","script","readyState","onreadystatechange","onload","optionscript","type","code","appendChild","createTextNode","head"],"mappings":"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","sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for PayUnity content in the gateways modal.\n *\n * @module     paygw_payunity/gateway_modal\n * @copyright  2022 Wunderbyte Gmbh <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Truncate from 'core/truncate';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_payunity/payunity_button_placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, payunityConfig]) => {\n        return Promise.all([\n            modal,\n            payunityConfig,\n            loadSdk(payunityConfig.purchaseid, payunityConfig.environment, payunityConfig.language),\n        ]);\n    })\n    .then(([modal, payunityConfig]) => {\n\n       const form = document.createElement('form');\n       const resourcePath = `/v1/checkouts/${payunityConfig.purchaseid}/payment`;\n       const url = `${payunityConfig.rooturl}/payment/gateway/payunity/checkout.php?resourcepath=${resourcePath}&itemid=${itemId}&orderid=${payunityConfig.purchaseid}&component=${component}&paymentarea=${paymentArea}`;\n       form.setAttribute('action', url);\n       form.classList.add('paymentWidgets');\n       form.setAttribute('data-brands', \"VISA MASTER AMEX\");\n        modal.setBody(form);\n        return '';\n    }).then(x => {\n        const promise = new Promise(resolve => {\n            window.addEventListener('onbeforeunload', (e) => {\n                promise.resolve();\n            });\n        });\n        return promise;\n    });\n};\n\n/**\n * Returns Form\n * @param {string} purchaseid Purchase Id\n * @param {string} environment Environment\n * @param {string} language Session language\n * @returns {Promise}\n */\nconst loadSdk = (purchaseid, environment, language) => {\n    let base = '';\n    if (environment === 'sandbox') {\n    base = 'https://eu-test.oppwa.com/';\n    } else {\n    base = 'https://eu-prod.oppwa.com/';\n    }\n    const sdkUrl = `${base}v1/paymentWidgets.js?checkoutId=${purchaseid}`;\n\n    // Check to see if this file has already been loaded. If so just go straight to the func.\n    if (loadSdk.currentlyloaded === sdkUrl) {\n        return Promise.resolve();\n    }\n\n    if (loadSdk.currentlyloaded) {\n        const suspectedScript = document.querySelector(`script[src=\"${loadSdk.currentlyloaded}\"]`);\n        if (suspectedScript) {\n            suspectedScript.parentNode.removeChild(suspectedScript);\n        }\n    }\n\n    const script = document.createElement('script');\n\n    return new Promise(resolve => {\n        if (script.readyState) {\n            script.onreadystatechange = function() {\n                if (this.readyState == 'complete' || this.readyState == 'loaded') {\n                    this.onreadystatechange = null;\n                    resolve();\n                }\n            };\n        } else {\n            script.onload = function() {\n                resolve();\n            };\n        }\n\n        script.setAttribute('src', sdkUrl);\n        const optionscript = document.createElement('script');\n        optionscript.type = 'text/javascript';\n        const lang = language;\n        const code = `var wpwlOptions = { locale: '${lang}'}`;\n        optionscript.appendChild(document.createTextNode(code));\n        document.head.appendChild(optionscript);\n        document.head.appendChild(script);\n        loadSdk.currentlyloaded = sdkUrl;\n    });\n};\n\n/**\n * Holds the full url\n *\n * @static\n * @type {string}\n */\n loadSdk.currentlyloaded = '';\n"],"file":"gateways_modal.min.js"}